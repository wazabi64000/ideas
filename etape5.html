<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Étape 5 – Authentification | Boîte à Idées</title>
  <link rel="stylesheet" href="public/css/styles.css">
</head>
<body>
<header>
  <nav class="navbar">
    <div class="nav-logo"><a href="index.html">Boîte à Idées</a></div>
    <button class="nav-toggle" id="nav-toggle" aria-label="Menu">☰</button>
    <ul class="nav-links" id="nav-links">
      <li><a href="index.html">Introduction</a></li>
      <li><a href="etape1.html">Étape 1</a></li>
      <li><a href="etape2.html">Étape 2</a></li>
      <li><a href="etape3.html">Étape 3</a></li>
      <li><a href="etape4.html">Étape 4</a></li>
      <li><a href="etape5.html">Étape 5</a></li>
      <li><a href="etape6.html">Étape 6</a></li>
      <li><a href="etape7.html">Étape 7</a></li>
      <li><a href="etape8.html">Étape 8</a></li>
      <li><a href="etape9.html">Étape 9</a></li>
      <li><a href="etape10.html">Étape 10</a></li>
      <li><a href="etape11.html">Étape 11</a></li>
      <li><a href="recap.html">Récapitulatif</a></li>
    </ul>
  </nav>
</header>

<main>
<section id="introduction">
<h1>Étape 5 – Authentification et gestion des rôles</h1>
<p>
Cette étape consiste à sécuriser l’application avec un système d’inscription, de connexion et de gestion des rôles (utilisateur/admin). 
Nous allons créer les routes backend et les formulaires Twig côté client.
</p>
</section>

<section id="outils">
<h2>Outils et dépendances</h2>
<ul>
<li>bcrypt – Hashage des mots de passe</li>
<li>jsonwebtoken – Création et validation de tokens JWT</li>
<li>Joi – Validation des données</li>
<li>Twig – Rendu des formulaires côté client</li>
</ul>
</section>

<section id="theorie">
<h2>Théorie et code</h2>
<pre><code>
// server.js – exemple minimal pour inscription/connexion
import express from "express";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";
import { body, validationResult } from "express-validator";
import UserModel from "./models/user.js";

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Route inscription
app.post("/register", async (req, res) => {
  const { pseudo, email, password, role } = req.body;
  const hashedPassword = await bcrypt.hash(password, 10);
  await UserModel.create({ pseudo, email, password: hashedPassword, role });
  res.redirect("/login");
});

// Route connexion
app.post("/login", async (req, res) => {
  const { email, password } = req.body;
  const user = await UserModel.findByEmail(email);
  if(!user) return res.status(401).send("Utilisateur non trouvé");
  const valid = await bcrypt.compare(password, user.password);
  if(!valid) return res.status(401).send("Mot de passe incorrect");
  const token = jwt.sign({ id: user.id, role: user.role }, process.env.JWT_SECRET, { expiresIn: "1h" });
  res.cookie("token", token, { httpOnly: true });
  res.redirect("/idees");
});
</code></pre>
</section>

<section id="formulaires">
<h2>Formulaires côté client (Twig)</h2>

<h3>Inscription – register.twig</h3>
<pre><code>
<form action="/register" method="POST">
  <label>Pseudo :</label>
  <input type="text" name="pseudo" required>

  <label>Email :</label>
  <input type="email" name="email" required>

  <label>Mot de passe :</label>
  <input type="password" name="password" required>

  <label>Rôle :</label>
  <select name="role">
    <option value="user" selected>User</option>
    <option value="admin">Admin</option>
  </select>

  <button type="submit">S'inscrire</button>
</form>
</code></pre>

<h3>Connexion – login.twig</h3>
<pre><code>
<form action="/login" method="POST">
  <label>Email :</label>
  <input type="email" name="email" required>

  <label>Mot de passe :</label>
  <input type="password" name="password" required>

  <button type="submit">Se connecter</button>
</form>
</code></pre>
</section> <pre><code>
{# fichier : views/etape6.twig #}

&lt;section id="formulaire"&gt;
  &lt;h2&gt;Soumettre une idée&lt;/h2&gt;
  &lt;!-- Formulaire d'envoi avec support d'image --&gt;
  &lt;form action="/idees" method="POST" enctype="multipart/form-data" class="form-idee"&gt;

    &lt;div class="form-group"&gt;
      &lt;label for="titre"&gt;Titre :&lt;/label&gt;
      &lt;input type="text" id="titre" name="titre" required&gt;
    &lt;/div&gt;

    &lt;div class="form-group"&gt;
      &lt;label for="description"&gt;Description :&lt;/label&gt;
      &lt;textarea id="description" name="description" rows="4" required&gt;&lt;/textarea&gt;
    &lt;/div&gt;

    &lt;div class="form-group"&gt;
      &lt;label for="image"&gt;Image :&lt;/label&gt;
      &lt;input type="file" id="image" name="image" accept="image/*"&gt;
    &lt;/div&gt;

    &lt;button type="submit"&gt;Envoyer&lt;/button&gt;

  &lt;/form&gt;
&lt;/section&gt;

&lt;!-- Affichage des idées existantes --&gt;
&lt;section id="liste-idees"&gt;
  &lt;h2&gt;Idées enregistrées&lt;/h2&gt;
  {% raw %}{% if idees and idees|length > 0 %}{% endraw %}
    &lt;ul class="liste-idees"&gt;
      {% raw %}{% for idee in idees %}{% endraw %}
        &lt;li class="idee"&gt;
          &lt;h3&gt;{% raw %}{{ idee.titre }}{% endraw %}&lt;/h3&gt;
          &lt;p&gt;{% raw %}{{ idee.description }}{% endraw %}&lt;/p&gt;
          {% raw %}{% if idee.image %}{% endraw %}
            &lt;img src="/public/uploads/{% raw %}{{ idee.image }}{% endraw %}" alt="Image de {% raw %}{{ idee.titre }}{% endraw %}" width="200"&gt;
          {% raw %}{% endif %}{% endraw %}
        &lt;/li&gt;
      {% raw %}{% endfor %}{% endraw %}
    &lt;/ul&gt;
  {% raw %}{% else %}{% endraw %}
    &lt;p&gt;Aucune idée enregistrée.&lt;/p&gt;
  {% raw %}{% endif %}{% endraw %}
&lt;/section&gt;
    </code></pre>


<section id="recap">
<h2>Récapitulatif</h2>
<ul>
<li>Routes backend `/register` et `/login` créées</li>
<li>Hashage des mots de passe avec bcrypt</li>
<li>JWT pour sécuriser les sessions</li>
<li>Formulaires Twig côté client prêts à l’emploi</li>
<li>Gestion des rôles `user` / `admin` intégrée</li>
</ul>
</section>

<section id="etape-suivante">
<p>Étape 6 : Upload d’images avec Multer et intégration côté serveur.</p>
</section>
</main>

<footer>
<p>Projet Boîte à Idées – Étape 5</p>
</footer>

<script src="public/js/script.js"></script>
</body>
</html>
